version: 2.1

jobs:
  cypress-local:
    docker:
      - image: cypress/included:12.17.0
    working_directory: ~/repo
    steps:
      - checkout

      # Start local server in background
      - run:
          name: Start local server
          command: npx http-server . -p 8080 &
      
      # Ensure Cypress results folder exists
      - run:
          name: Ensure results folder exists
          command: mkdir -p cypress/results

      # Run Cypress tests against localhost
      - run:
          name: Run Cypress local tests
          command: npx cypress run --config baseUrl=http://localhost:8080 --reporter junit --reporter-options "mochaFile=cypress/results/results-local-[hash].xml,toConsole=true"
          timeout: 20m

      - store_artifacts:
          path: cypress/videos
          destination: cypress-videos
      - store_artifacts:
          path: cypress/screenshots
          destination: cypress-screenshots
      - store_test_results:
          path: cypress/results

  cypress-live:
    docker:
      - image: cypress/included:12.17.0
    working_directory: ~/repo
    steps:
      - checkout

      # Ensure Cypress results folder exists
      - run:
          name: Ensure results folder exists
          command: mkdir -p cypress/results

      # Run Cypress tests against live GitHub Pages site
      - run:
          name: Run Cypress live tests
          command: |
            if [ -z "$GH_PAGES_URL" ]; then
              echo "Error: GH_PAGES_URL env var is not set. Set it in CircleCI project settings.";
              exit 1;
            fi
            npx cypress run --config baseUrl=$GH_PAGES_URL --reporter junit --reporter-options "mochaFile=cypress/results/results-live-[hash].xml,toConsole=true"
          timeout: 20m

      - store_artifacts:
          path: cypress/videos
          destination: cypress-videos-live
      - store_artifacts:
          path: cypress/screenshots
          destination: cypress-screenshots-live
      - store_test_results:
          path: cypress/results

workflows:
  build-and-test:
    jobs:
      - cypress-local
      - cypress-live:
          requires:
            - cypress-local
